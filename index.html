<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام بحث وقف فاطمة هانم البقلية</title>
    
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root{--main:#0f3460;--accent:#1e56a0;--success:#16a085;--light:#f8f9fa;--gray:#6c757d;--border:#dee2e6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#f0f4f8,#d9e2ec);min-height:100vh;padding:15px 10px;line-height:1.6}
        .container{max-width:1500px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,.12);overflow:hidden}
        header{background:linear-gradient(120deg,var(--main),var(--accent));color:white;padding:30px 20px;text-align:center}
        h1{font-size:2.3rem;margin-bottom:8px}.subtitle{font-size:1.2rem;opacity:.95}
        .loading{text-align:center;padding:60px;font-size:1.5rem;color:#555;background:#f8f9fa;margin:20px;border-radius:15px}
        .actions{padding:20px;background:#f1f5f9;display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
        .btn{padding:13px 28px;border:none;border-radius:12px;font-weight:bold;cursor:pointer;font-size:1rem;transition:all .3s;display:inline-flex;align-items:center;gap:8px;color:white}
        .btn-primary{background:var(--accent)}.btn-success{background:var(--success)}.btn:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.2)}
        .controls{padding:25px;background:white;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;border-bottom:2px solid var(--border)}
        .search-box{position:relative}
        #globalSearch{width:100%;padding:16px 55px 16px 20px;border:2px solid #ddd;border-radius:14px;font-size:1.1rem;transition:all .3s}
        #globalSearch:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 5px rgba(30,86,160,.15)}
        .search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:1.5rem;color:var(--gray)}
        select{padding:16px;border:2px solid #ddd;border-radius:14px;font-size:1.05rem;background:white}
        select:focus{outline:none;border-color:var(--accent)}
        .stats{padding:18px 25px;background:#ecfdf5;color:var(--success);font-weight:bold;font-size:1.2rem;text-align:center}
        .table-container{overflow-x:auto;padding:0 20px 20px}
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;font-size:1rem}
        th{background:var(--main);color:white;padding:18px 12px;text-align:center;font-weight:bold;position:sticky;top:0;z-index:10}
        td{padding:16px 10px;text-align:center;border-bottom:1px solid var(--border)}
        tr:hover{background:#f8f9fa}
        .highlight{background:#dbeafe!important;font-weight:bold;color:#1e40af}
        .journal-num{font-weight:900;font-size:1.1em;color:#1e40af}
        .card-view{display:none;padding:15px}
        .card{background:white;border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:18px;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .card h3{background:var(--accent);color:white;padding:15px;border-radius:10px;margin:-20px -20px 20px -20px;font-size:1.4rem;text-align:center}
        .card p{margin:12px 0}.card span{font-weight:bold;color:var(--main)}
        .error{color:#c41e3a;background:#fee2e2;padding:20px;border-radius:12px;margin:20px;text-align:center}
        @media(max-width:992px){.table-container{display:none}.card-view{display:block}h1{font-size:1.9rem}}
        @media(max-width:480px){.actions{flex-direction:column}.btn{width:100%;justify-content:center}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>نظام بحث وقف فاطمة هانم البقلية</h1>
            <p class="subtitle">تحديث تلقائي يومي - جميع الأحواض والمنافع والتعديات</p>
        </header>

        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin fa-3x"></i><br><br>
            جاري تحميل البيانات...
        </div>

        <div id="error" class="error" style="display:none;"></div>

        <div id="app" style="display:none;">
            <div class="actions">
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> تصدير إلى إكسل
                </button>
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> طباعة
                </button>
            </div>

            <div class="controls">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="globalSearch" placeholder="ابحث برقم الجريدة أو الاسم أو الحوض أو التعديات...">
                </div>
                <select id="filterHolder"><option value="">جميع واضعي اليد</option></select>
                <select id="filterBasin"><option value="">جميع الأحواض</option></select>
            </div>

            <div class="stats">
                تم العثور على <strong><span id="resultCount">0</span></strong> سجل من إجمالي <strong><span id="totalCount">0</span></strong>
            </div>

            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>الجريده</th>
                            <th>اسم المستأجر / واضع اليد</th>
                            <th>اسم الوقف</th>
                            <th>الناحية</th>
                            <th>س</th><th>ط</th><th>ف</th>
                            <th>التعديات</th>
                            <th>نوع الحوض</th>
                            <th>اسم الحوض</th>
                            <th>س2</th><th>ط2</th><th>ف2</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="card-view" id="cardView"></div>
        </div>
    </div>

    <script>
        const CSV_URL = "https://raw.githubusercontent.com/abukora/waqf-pro/main/waqf-pro.csv";
        let data = [], fuse;

        const options = {
            keys: ['journalNumber','holder','waqf','area','encroach','basinType','basinName','s','t','f','s2','t2','f2','extra'],
            threshold: 0.3
        };

        function exportToExcel() {
            const filteredData = getCurrentResults();
            const ws = XLSX.utils.json_to_sheet(filteredData.map(item => ({
                "الجريده": item.journalNumber,
                "اسم المستأجر / واضع اليد": item.holder + (item.extra ? " ("+item.extra+")" : ""),
                "اسم الوقف": item.waqf,
                "الناحية": item.area,
                "س": item.s,
                "ط": item.t,
                "ف": item.f,
                "التعديات": item.encroach,
                "نوع الحوض": item.basinType,
                "اسم الحوض": item.basinName,
                "س2": item.s2,
                "ط2": item.t2,
                "ف2": item.f2
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "وقف فاطمة هانم");
            XLSX.writeFile(wb, "وقف_فاطمة_هانم_البقلية_" + new Date().toISOString().slice(0,10) + ".xlsx");
        }

        function getCurrentResults() {
            let f = [...data];
            const q = document.getElementById('globalSearch').value.trim();
            if (q) {
                if (!fuse) fuse = new Fuse(data, options);
                f = fuse.search(q).map(x => x.item);
            }
            const h = document.getElementById('filterHolder').value;
            if (h) f = f.filter(x => x.holder === h);
            const b = document.getElementById('filterBasin').value;
            if (b) f = f.filter(x => x.basinName === b);
            return f;
        }

        function renderResults(items) {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            const cards = document.getElementById('cardView'); cards.innerHTML = '';
            document.getElementById('resultCount').textContent = items.length;

            items.forEach(item => {
                // الجدول
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="journal-num"><strong>${item.journalNumber}</strong></td>
                    <td class="highlight">${item.holder}${item.extra ? `<br><small style="color:#c41e3a">(${item.extra})</small>` : ""}</td>
                    <td>${item.waqf}</td><td>${item.area}</td>
                    <td>${item.s}</td><td>${item.t}</td><td>${item.f}</td>
                    <td>${item.encroach}</td><td>${item.basinType}</td><td>${item.basinName}</td>
                    <td>${item.s2}</td><td>${item.t2}</td><td>${item.f2}</td>`;
                tbody.appendChild(tr);

                // الكارت
                const card = document.createElement('div'); card.className = 'card';
                card.innerHTML = `
                    <h3>الجريده: ${item.journalNumber}</h3>
                    <p><span>المستأجر:</span> ${item.holder} ${item.extra ? `<small style="color:#c41e3a">(${item.extra})</small>` : ""}</p>
                    <p><span>الوقف:</span> ${item.waqf}</p>
                    <p><span>الناحية:</span> ${item.area}</p>
                    <p><span>المساحة:</span> ${item.s} س، ${item.t} ط، ${item.f} ف</p>
                    <p><span>التعديات:</span> ${item.encroach}</p>
                    <p><span>الحوض:</span> ${item.basinType} - ${item.basinName}</p>
                    ${item.s2 || item.t2 || item.f2 ? `<p><span>فرعي:</span> ${item.s2} ${item.t2} ${item.f2}</p>` : ''}`;
                cards.appendChild(card);
            });
        }

        function populateFilters() {
            const holders = [...new Set(data.map(x => x.holder))].sort((a,b) => a.localeCompare(b, 'ar'));
            const basins = [...new Set(data.map(x => x.basinName))].filter(Boolean).sort((a,b) => a.localeCompare(b, 'ar'));
            const hSelect = document.getElementById('filterHolder');
            const bSelect = document.getElementById('filterBasin');
            holders.forEach(name => hSelect.add(new Option(name, name)));
            basins.forEach(name => bSelect.add(new Option(name, name)));
        }

        function filterData() {
            renderResults(getCurrentResults());
        }

        // تحميل البيانات
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            encoding: "UTF-8",
            error: function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = "فشل تحميل البيانات. تأكد من الاتصال بالإنترنت.";
            },
            complete: function(res) {
                if (!res.data || res.data.length === 0) {
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = "لا توجد بيانات لعرضها.";
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                data = res.data.map((r, i) => ({
                    serial: i + 1,
                    journalNumber: (r["الجريده"] || r["الجريده"] || r["الجريده"] || r["كود"] || r["كود المستأجر"] || "غير محدد").trim() || "غير محدد",
                    holder: (r["اسم المستأجر"] || "").trim(),
                    waqf: (r["اسم الوقف"] || "فاطمة هانم البقلية").trim(),
                    area: (r["الناحية"] || "").trim(),
                    s: parseInt(r["س"]) || 0,
                    t: parseInt(r["ط"]) || 0,
                    f: parseInt(r["ف"]) || 0,
                    encroach: (r["التعديات"] || "لا يوجد").trim(),
                    basinType: (r["الحوض/منافع"] || "").trim(),
                    basinName: (r["اسم الحوض"] || "").trim(),
                    s2: (r["س2"] || "").trim(),
                    t2: (r["ط2"] || "").trim(),
                    f2: (r["ف2"] || "").trim(),
                    extra: (r["واضع اليد 1"] || "").trim()
                })).filter(x => x.holder);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('totalCount').textContent = data.length;

                populateFilters();
                renderResults(data);
            }
        });

        document.getElementById('globalSearch').addEventListener('input', filterData);
        document.getElementById('filterHolder').addEventListener('change', filterData);
        document.getElementById('filterBasin').addEventListener('change', filterData);
    </script>
</body>
</html>
